<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="author" content="Adam Reid">
<meta name="description" content="Personal site for Adam Reid">
<meta name="generator" content="mynt v0.2.2">

<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<link rel="alternate" href="/feed.xml" type="application/atom+xml">

<link rel="stylesheet" href="/assets/css/screen.css" type="text/css">
<link rel="stylesheet" href="/assets/css/pygments.css" type="text/css">


    
    <title>Kickstarting a CentOS / RedHat 4 Vagrant Image &ndash; Adam Reid</title>
</head>

<body>
    <div id="container">
        <div id="nav">
            <ul>
                <li><a href="/">Blog</a></li>
                <li><a href="/archives/">Archives</a></li>
                <li><a href="/feed.xml">Feed</a></li>
            </ul>
            
            
                <ul id="social">
                    
                    
                    <li><a href="https://github.com/adamreid"><img src="/assets/images/social/github.png" width="16" height="16" alt="GitHub"></a></li>
                    <li><a href="https://plus.google.com/104846165015405586049"><img src="/assets/images/social/google-plus.png" width="16" height="16" alt="Google+"></a></li>
                    
                    
                    
                    
                </ul>
            
        </div>
        
        <div id="header">
            <h1><a href="/">Adam Reid</a></h1>
            
        </div>
        
        <div id="content">
            
    <div class="item">
        <div class="header">
            <h1>Kickstarting a CentOS / RedHat 4 Vagrant Image</h1>
            <h2>Monday, May 21, 2012 <span>&raquo;</span> <a href="/tags/Puppet/">Puppet</a>, <a href="/tags/Vagrant/">Vagrant</a></h2>
        </div>
        
        <div class="body">
            <p>In my <a href="http://adamreid.ca/2012/05/15/Kickstarting-Puppet-On-Centos4/">previous post</a> I explained one way to get <a href="http://puppetlabs.com/">puppet</a> running on CentOS 4 / RedHat ES-4 using a kickstart. Building from that kickstart, I am going to show how to set up a <a href="https://www.virtualbox.org/">VirtualBox</a> VM suitable for use with <a href="http://vagrantup.com/">Vagrant</a>. Although I focus on a dated distribution here, these instructions can be applied to other distributions pretty easily. The kickstart can only be used by distributions that support kickstart installations. That means any RedHat or CentOS and possibly others with modifications.</p>

<p>If you don&#39;t know why you might want to use <a href="http://vagrantup.com/">Vagrant</a> I will briefly explain. Vagrant is a tool that combines virtualization via VirtualBox with configuration management via <a href="http://puppetlabs.com/">Puppet</a> and/or <a href="http://www.opscode.com/chef/">Chef</a> to let you create reproducible development environments. You write a <code>Vagrantfile</code> that tells vagrant what your machine should look like and what puppet/chef configurations to apply. This means you don&#39;t need to keep a lot of VM&#39;s around when they aren&#39;t being used. Instead you can re-create the machine with vagrant when you need it, and destroy it when you&#39;re done. It has some nice features such as automatic ssh forwarding, optional port forwarding of other services (http for example), and automatic folder sharing. This last one is really nice, as it lets you write an application on your PC with whatever tools you would normally use and automatically have the code available in a VM for testing.</p>

<p>In this kickstart I don&#39;t provide Chef, although it can be added with <code>gem install chef --no-doc --no-ri</code> if you would like it to be included in your images.</p>
<h2>The set up</h2>
<p>For this to work you are going to need the following things on your PC. I will not go into the details of installing VirtualBox or Vagrant, they both have excellent documentation available.</p>

<ul>
<li><a href="https://www.virtualbox.org/">VirtualBox</a></li>
<li><a href="http://vagrantup.com/">Vagrant</a></li>
<li>A terminal</li>
<li>A CentOS / RedHat 4 DVD iso</li>
<li>A web server, I use Python 2.7 and <code>python -m &#39;http.server&#39;</code></li>
</ul>

<p>When VirtualBox is installed, copy (or link), the <code>VBoxGuestAdditions.iso</code> file into a directory to work in. For linux hosts you can usually find it in <code>/usr/lib/virtualbox/additions</code>, for Mac OS hosts it will be in <code>/Applications/VirtualBox.app/MacOS/</code>. Grab a copy of the latest <a href="https://raw.github.com/adamreid/kickstarts/master/puppet-es4-vagrant-ks.cfg">kickstart</a> from github. Serve these files via http using your favourite web server. I<br>
use Python and it&#39;s <code>http.server</code> module for Python 2.7 or <code>SimpleHTTPServer</code> for versions &lt; 2.7.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre>areid <span class="nv">$ </span><span class="nb">cd</span> ~/kickstarts/puppet
puppet <span class="nv">$ </span>ln -s /usr/lib/virtualbox/additions/VBoxGuestAdditions.iso .
puppet <span class="nv">$ </span>wget https://raw.github.com/adamreid/kickstarts/master/puppet-es4-vagrant-ks.cfg
puppet <span class="nv">$ </span>python -m <span class="s1">&#39;http.server&#39;</span>
Serving HTTP on 0.0.0.0 port 8000 ...
</pre></div>
</td></tr></table></div></div><h2>The kickstart</h2>
<p>This kickstart is an extension of the <a href="http://adamreid.ca/2012/05/15/Kickstarting-Puppet-On-Centos4/">puppet-es4</a> with the addition of a few steps to ready it for <a href="http://vagrantup.com/">vagrant</a> and the disabling of a few services that I would consider unnecessary for the VM&#39;s intended purpose.</p>

<p>Most changes here are to conform to the conventions outlined in the <a href="http://vagrantup.com/docs/base_boxes.html">Vagrant base box</a> documentation. Specifically:<br>
* The root password is changed to vagrant.<br>
* The vagrant user is added to the admin group.<br>
* The admin group is given passwordless sudo access.<br>
* The vagrant user&#39;s <code>.ssh/authorized_keys</code> file contains a known (insecure) key for pubkey authentication.<br>
* The VirtualBox guest additions are installed.</p>

<p>A final step is then run to help keep the size of the exported vagrant box down. A file is created in <code>/tmp</code> and filled with 0&#39;s until the disk runs out of space, then is deleted. This step is optional. If you are doing repeated testing of the kickstart, this step should be commented out to save time.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># Kickstart file for Puppet on CentOS 4/RedHat ES-4</span>
<span class="c"># Tested on ES-4 U8 / CentOS 4.8</span>
<span class="c"># May work on older enterprise 4 systems.</span>
<span class="c">#</span>
<span class="c"># Adam Reid</span>
<span class="c"># http://github.com/adamreid/kickstarts/puppet-es4-ks.cfg</span>

install
cdrom
lang en_US.UTF-8
langsupport --default<span class="o">=</span>en_US.UTF-8 en_US.UTF-8
keyboard us
xconfig --card <span class="s2">&quot;VESA driver (generic)&quot;</span> --videoram 12288 --hsync 31.5-37.9 --vsync 50-70 --resolution 800x600 --depth 16
network --device eth0 --bootproto dhcp
rootpw vagrant
firewall --disabled
selinux --disabled
authconfig --enableshadow --passalgo<span class="o">=</span>md5
timezone --utc America/New_York
bootloader --location<span class="o">=</span>mbr
<span class="c"># The following is the partition information you requested</span>
<span class="c"># Note that any partitions you deleted are not expressed</span>
<span class="c"># here so unless you clear all partitions first, this is</span>
<span class="c"># not guaranteed to work</span>
clearpart --all --drives<span class="o">=</span>sda
part /boot --fstype ext3 --size<span class="o">=</span>100 --ondisk<span class="o">=</span>sda
part pv.2 --size<span class="o">=</span>0 --grow --ondisk<span class="o">=</span>sda
volgroup VolGroup00 --pesize<span class="o">=</span>32768 pv.2
logvol swap --fstype swap --name<span class="o">=</span>LogVol01 --vgname<span class="o">=</span>VolGroup00 --size<span class="o">=</span>512 --grow --maxsize<span class="o">=</span>1024
logvol / --fstype ext3 --name<span class="o">=</span>LogVol00 --vgname<span class="o">=</span>VolGroup00 --size<span class="o">=</span>1024 --grow

%packages
lvm2
kernel
e2fsprogs
grub

<span class="c"># required to build ruby</span>
<span class="c"># should be kept for gems that build native extensions.</span>
automake
gcc
cpp
glibc-devel
glibc-headers
glibc-kernheaders
glibc
glibc-common
libgcc

<span class="c"># required to build ruby bindings, can be removed after</span>
zlib-devel
openssl-devel
readline-devel

%post

<span class="c"># Change to a vt to see progress</span>

<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

<span class="c"># redirect output to ks-post.log including stdout and stderr</span>
<span class="o">(</span>
    <span class="c">#######################################################</span>
    <span class="c"># Build Ruby</span>
    <span class="c">#######################################################</span>

    <span class="c"># Keep it clean</span>
    mkdir /tmp/ruby
    <span class="nb">cd</span> /tmp/ruby

    <span class="c"># autoconf 2.60 is required to build ruby</span>
    wget http://ftp.gnu.org/gnu/autoconf/autoconf-2.60.tar.gz
    tar -xzf autoconf-2.60.tar.gz
    <span class="nb">cd </span>autoconf-2.60
    ./configure --prefix<span class="o">=</span>/usr <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
    <span class="nb">cd</span> /tmp/ruby

    <span class="c"># build ruby-1.8.7-p358</span>
    wget http://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p358.tar.bz2
    tar -xjf ruby-1.8.7-p358.tar.bz2
    <span class="nb">cd </span>ruby-1.8.7-p358
    autoconf
    ./configure --prefix<span class="o">=</span>/usr <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
    <span class="nb">cd</span> /tmp/ruby

    <span class="c"># install ruby-gems 1.8.10</span>
    wget http://production.cf.rubygems.org/rubygems/rubygems-1.8.10.tgz
    tar -xzf rubygems-1.8.10.tgz
    <span class="nb">cd </span>rubygems-1.8.10
    /usr/bin/ruby setup.rb


    <span class="c"># clean up</span>
    <span class="nb">cd</span> /
    rm -rf /tmp/ruby

    <span class="c">#######################################################</span>
    <span class="c"># Install Puppet</span>
    <span class="c">#######################################################</span>
    gem install puppet --no-rdoc --no-ri

    <span class="c"># add the puppet group</span>
    groupadd puppet

    <span class="c">#######################################################</span>
    <span class="c"># Install VirtualBox Guest Additions</span>
    <span class="c">#</span>
    <span class="c"># Note: You will need to provide a copy of the</span>
    <span class="c"># VirtualBoX Guest Addititons iso on a web server.</span>
    <span class="c">#######################################################</span>
    <span class="nb">cd</span> /tmp
    wget http://192.168.1.3:8000/VBoxGuestAdditions.iso
    mkdir /tmp/isomount
    mount -t iso9660 -o loop /tmp/VBoxGuestAdditions.iso /tmp/isomount

    /tmp/isomount/VBoxLinuxAdditions.run
    umount isomount
    rm VBoxGuestAdditions.iso

    <span class="c">#######################################################</span>
    <span class="c"># Turn off un-needed services</span>
    <span class="c">#######################################################</span>
    chkconfig sendmail off
    chkconfig vbox-add-x11 off
    chkconfig smartd off
    chkconfig ntpd off
    chkconfig cupsd off

    <span class="c">#######################################################</span>
    <span class="c"># Setup for Vagrant</span>
    <span class="c">#######################################################</span>
    groupadd admin
    useradd -g admin vagrant
    <span class="nb">echo</span> <span class="s1">&#39;Defaults env_keep=&quot;SSH_AUTH_SOCK&quot;&#39;</span> &gt;&gt; /etc/sudoers
    <span class="nb">echo</span> <span class="s1">&#39;%admin    ALL=NOPASSWD: ALL&#39;</span> &gt;&gt; /etc/sudoers

    <span class="c"># Add vagrant insecure private key for key auth</span>
    <span class="c"># Make your own if this is private.</span>
    <span class="c"># See http://vagrantup.com/docs/base_boxes.html</span>
    mkdir /home/vagrant/.ssh
    <span class="nb">echo</span> <span class="s2">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key&quot;</span> &gt; /home/vagrant/.ssh/authorized_keys

    <span class="c"># Clean up unused disk space so compressed image is smaller.</span>
    cat /dev/zero &gt; /tmp/zero.fill
    rm /tmp/zero.fill

    <span class="c">#######################################################</span>
    <span class="c"># The system can now be packaged with </span>
    <span class="c"># `vagrant package VMNAME`</span>
    <span class="c">#######################################################</span>
    <span class="nb">echo</span> <span class="s1">&#39;You can now package this box with `vagrant package VMNAME`&#39;</span>

<span class="o">)</span> 2&gt;&amp;1 | /usr/bin/tee /root/ks-post.log

<span class="c"># switch back to gui</span>
chvt 7
</pre></div>
</td></tr></table></div></div><h2>Creating the Vagrant Image</h2>
<p>Now that the kickstart has been installed it is ready to be packaged as a vagrant base box.</p>

<p>I named my base image <em>vagrant-es4</em> in VirtualBox, so when following this example make sure to replace my VM name with yours.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>puppet <span class="nv">$ </span>vagrant package --base vagrant-es4
puppet <span class="nv">$ </span>vagrant box add es4base package.box
</pre></div>
</td></tr></table></div></div>
<p>The image is now ready for you to use in your own vagrant images. Create a new vagrant configuration to test the base image with.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre>puppet <span class="nv">$ </span><span class="nb">cd</span> ~/vms
vms <span class="nv">$ </span>mkdir es4test
vms <span class="nv">$ </span><span class="nb">cd </span>es4test
vms <span class="nv">$ </span>vagrant init es4base
vms <span class="nv">$ </span>vagrant up
vms <span class="nv">$ </span>vagrant ssh
</pre></div>
</td></tr></table></div></div>
<p>The last command <code>vagrant ssh</code> gives you shell access to the virtual machine you just created. If you look in the machines <code>/vagrant</code> directory you will notice that your <code>Vagrantfile</code> is there. This is a VirtualBox &quot;shared folder&quot; that is provided for you by vagrant. The directory it&#39;s sharing is the same directory that <code>vagrant init</code> was run inside of in the steps above. </p>

<p>When developing an application you can see how this little convenience will make a big difference in testing your application in a virtual environment. You just create a <code>Vagrantfile</code> with the configuration you require, spin up the VM, and run your application from the shared folder. Keeping the <code>Vagrantfile</code> in source with your application will remind you to keep it up to date as the applications requirements change, and makes it easy for new developers to quickly set up a known-good environment to test in.</p>

        </div>
    </div>

        </div>
        
        <div id="footer">
            <p>Copyright &copy; 2012 Adam Reid &ndash; powered by <a href="http://mynt.mirroredwhite.com/">mynt</a></p>
        </div>
    </div>
</body>
</html>